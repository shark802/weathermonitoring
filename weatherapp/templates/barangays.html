{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manage Barangays</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{% static 'css/logout.css' %}">
    <style>
        .dataTables_wrapper {
            z-index: 20; 
            position: relative; 
        }

        @media (max-width: 767px) {
            main {
                margin-left: 0 !important;
                padding: 1rem !important;
            }
            
            .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .modal-dialog {
                margin: 0.5rem auto;
                max-width: 95%;
            }
            .add-sensor-btn-mobile {
                width: auto;
                min-width: 120px;
                padding: 0.5rem 1rem;
                margin-left: auto;
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans min-h-screen">

    {% if messages %}
      {% for message in messages %}
        <div class="fixed top-4 left-1/2 transform -translate-x-1/2 max-w-md w-full z-50">
          <div class="mb-4 px-6 py-4 text-white rounded-lg shadow-md text-center 
                        {% if message.tags == 'error' %}bg-red-500{% else %}bg-green-500{% endif %}">
            {{ message }}
          </div>
        </div>
      {% endfor %}
    {% endif %}

    {% include "weather/header.html" %}

    <div class="flex pt-16">
      {% include "weather/aside.html" %}

      <main class="w-full md:ml-64 p-4 md:p-6 space-y-6 transition-all duration-300">
        <div class="info-box w-full">
          <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-6 gap-4">
            <h4 class="text-xl font-semibold">Manage Barangays</h4>             
          </div>

          <div class="overflow-x-auto">
            <table id="barangayTable" class="min-w-full border border-gray-300 text-base">
              <thead class="bg-blue-600 text-white">
                <tr>
                  <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Barangay Name</th>
                  <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Land Description</th>
                  <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Flood Risk</th>
                  <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Summary</th>
                  <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for barangay in barangays %}
                <tr class="hover:bg-gray-200">
                  <td class="px-4 py-2">{{ barangay.barangay_name }}</td>
                  <td class="px-4 py-2">{{ barangay.land_description }}</td>
                  <td class="px-4 py-2">{{ barangay.flood_risk_multiplier }}</td>
                  <td class="px-4 py-2">{{ barangay.flood_risk_summary }}</td>
                  <td class="px-4 py-2">
                    <div class="action-buttons flex space-x-2 items-center">
                        <button class="btn btn-sm btn-warning"
                                data-bs-toggle="modal" data-bs-target="#updateBarangayModal"
                                data-id="{{ barangay.id }}"
                                data-barangay_name="{{ barangay.barangay_name }}"
                                data-land_description="{{ barangay.land_description }}"
                                data-flood_risk_multiplier="{{ barangay.flood_risk_multiplier }}"
                                data-flood_risk_summary="{{ barangay.flood_risk_summary }}">
                        <i class="bi bi-pencil-square" data-bs-toggle="tooltip" title="Edit Barangay"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </main>

<div class="modal fade" id="updateBarangayModal" tabindex="-1" aria-labelledby="updateBarangayModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg mx-auto">
          <div class="modal-content border-0 shadow-lg">
            <form method="POST" action="{% url 'update_barangay' %}" id="updateBarangayForm">
              {% csrf_token %}
              <div class="modal-header bg-blue-600 text-white rounded-t-lg position-relative">
                <h5 class="modal-title fw-bold w-100 text-center" id="updateBarangayModalLabel">Update Barangay</h5>
                <button type="button" class="btn-close btn-close-white position-absolute end-0 me-2" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              
              <div class="modal-body p-4 p-md-5">
                <input type="hidden" id="update-id" name="id">
                
                <div class="mb-4">
                  <label for="update-barangay-name" class="form-label fw-semibold text-gray-700">Barangay Name <span class="text-danger">*</span></label>
                  <input type="text" class="form-control py-2 px-3 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-blue-500" 
                        id="update-barangay-name" name="barangay_name" required>
                </div>
                
                <div class="mb-4">
                  <label for="update-land-description" class="form-label fw-semibold text-gray-700">Land Description <span class="text-danger">*</span></label>
                  <select class="form-select py-2 px-3 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-blue-500" 
                          id="update-land-description" name="land_description" required>
                      <option value="" disabled selected>Select Land Description</option>
                      {# The replace filter is needed if your key has underscores, like 'low_lying' #}
                      {% for key, info in LAND_RISK_OPTIONS.items %}
                          <option value="{{ key }}">{{ key|title }}</option>
                      {% endfor %}
                  </select>
                </div>

                <div class="mb-4">
                  <label for="display-risk-multiplier" class="form-label fw-semibold text-gray-700">Flood Risk Multiplier (Auto-filled)</label>
                  <input type="text" id="display-risk-multiplier" class="form-control py-2 px-3 border-gray-300 rounded-lg bg-gray-100" readonly>
                  <input type="hidden" id="update-risk-multiplier" name="flood_risk_multiplier">
                </div>

                <div class="mb-4">
                  <label for="display-risk-summary" class="form-label fw-semibold text-gray-700">Flood Risk Summary (Auto-filled)</label>
                  <textarea id="display-risk-summary" class="form-control py-2 px-3 border-gray-300 rounded-lg bg-gray-100" rows="2" readonly></textarea>
                  <input type="hidden" id="update-risk-summary" name="flood_risk_summary">
                </div>
              
              </div>
              
              <div class="modal-footer bg-gray-50 rounded-b-lg px-4 py-3 sm:px-6">
                <div class="w-full flex flex-col sm:flex-row justify-end gap-3">
                  <button type="button" 
                          class="btn btn-outline-secondary w-full sm:w-auto px-4 py-2 text-sm font-medium"
                          data-bs-dismiss="modal">
                    Cancel
                  </button>
                  <button type="submit" 
                          class="btn btn-success w-full sm:w-auto px-4 py-2 text-sm font-medium"
                          id="updateSensorSubmit">
                    <span id="updateSensorSubmitText" class="flex items-center justify-center gap-2">
                      <i class="fas fa-save"></i> Save Changes
                    </span>
                    <span id="updateSensorSpinner" class="spinner-border spinner-border-sm d-none ms-2" role="status" aria-hidden="true"></span>
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
<div id="logoutModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen p-4">
          <div class="fixed inset-0 bg-gray-900 bg-opacity-50 transition-opacity" aria-hidden="true"></div>
          
          <div class="relative bg-white rounded-xl shadow-2xl overflow-hidden w-full max-w-md transform transition-all">
            <div class="p-6">
              <div class="flex items-start">
                <div class="flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-50">
                  <i class="fas fa-sign-out-alt text-red-600 text-xl"></i>
                </div>
                
                <div class="ml-4">
                  <h3 class="text-xl font-semibold text-gray-900">Log out of your account?</h3>
                  <div class="mt-2">
                    <p class="text-gray-600">You'll need to log in again to access your dashboard.</p>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="bg-gray-50 px-6 py-4 flex flex-col-reverse sm:flex-row sm:justify-end gap-3">
              <button type="button" onclick="hideLogoutModal()" 
                      class="px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors">
                Cancel
              </button>
              <button type="button" onclick="performLogout()" 
                      class="px-4 py-2 text-sm font-medium text-white bg-red-600 hover:bg-red-700 rounded-lg shadow-sm transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                Log Out
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="modal fade" id="sendAlertModal" tabindex="-1" aria-labelledby="sendAlertModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-xl rounded-xl">
            <form method="POST" action="{% url 'send_alert' %}" id="sendAlertForm">
                {% csrf_token %}
                <div class="modal-header bg-red-600 text-white rounded-t-xl border-b-0 relative">
                    <div class="w-full text-center py-2">
                        <h5 class="modal-title text-2xl font-extrabold" id="sendAlertModalLabel">
                            <i class="fas fa-bullhorn mr-2"></i> SEND EMERGENCY ALERT
                        </h5>
                    </div>
                    <button type="button" class="btn-close btn-close-white absolute right-4 top-4 opacity-70 hover:opacity-100 transition" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <div class="modal-body p-6 space-y-6">
                    <h6 class="font-bold text-lg text-red-700 flex items-center border-b pb-2 mb-4">
                        <i class="fas fa-exclamation-triangle mr-2 text-red-500"></i>
                        Alert Details & Message
                    </h6>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="alert_type" class="block text-sm font-bold text-gray-700 mb-1">Alert Type</label>
                            <select class="w-full rounded-lg border-gray-300 focus:border-red-500 focus:ring-red-500 shadow-sm transition" 
                                    id="alert_type" name="alert_type" required>
                                <option value="rain">Rain Alert</option>
                                <option value="wind">Wind Alert</option>
                            </select>
                        </div>
                        <div>
                            <label for="severity" class="block text-sm font-bold text-gray-700 mb-1">Severity Level</label>
                            <select class="w-full rounded-lg border-gray-300 focus:border-red-500 focus:ring-red-500 shadow-sm transition" 
                                    id="severity" name="severity" required>
                                <option value="Heavy">Heavy</option>
                                <option value="Intense">Intense</option>
                                <option value="Torrential">Torrential</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label for="alert_message" class="block text-sm font-bold text-gray-700 mb-1">Custom Alert Message</label>
                        <textarea class="w-full rounded-lg border-gray-300 focus:border-red-500 focus:ring-red-500 shadow-sm" 
                                  id="alert_message" name="alert_message" rows="3" 
                                  placeholder="E.g., Expect severe flooding in low-lying areas. Seek higher ground immediately."></textarea>
                    </div>

                    <div id="alert-status" class="mt-4 text-center font-bold text-sm"></div>
                </div>
                
                <div class="modal-footer bg-gray-50 rounded-b-xl px-6 py-4 flex flex-col sm:flex-row-reverse gap-3">
                    <button type="submit" 
                              class="w-full sm:w-auto px-6 py-2 bg-red-600 text-white font-extrabold rounded-lg hover:bg-red-700 focus:outline-none focus:ring-4 focus:ring-red-300 transition-colors shadow-md flex items-center justify-center gap-2 text-lg"
                              id="sendAlertButton">
                        <i class="fas fa-paper-plane"></i> Send Alert
                    </button>
                    <button type="button" 
                              class="w-full sm:w-auto px-6 py-2 bg-white border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-colors shadow-sm"
                              data-bs-dismiss="modal">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

      <div id="loadingOverlay" class="hidden fixed inset-0 z-50 bg-white bg-opacity-80 flex flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
        <p class="mt-4 text-lg font-medium text-gray-700">Logging out...</p>
      </div>
    </div>

    {{ LAND_RISK_OPTIONS|json_script:"land-risk-options" }}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
    const alertTypeSelect = document.getElementById('alert_type');
    const severitySelect = document.getElementById('severity');
    
    // --- 1. Robustly Group Options ---
    const allOptions = Array.from(severitySelect.options);

    // FIX: Define the complete list of all potential severity options.
    // Since the original HTML only had Rain options, we add the Wind options here.
    // If your HTML contained all options (Rain first, then Wind), this logic would be simpler.
    
    // 1. Group the currently visible options (Rain options)
    const rainOptions = allOptions; 

    // 2. Define the missing Wind options (assuming these are the desired levels)
    const windOptionsData = [
        { value: 'Gale', text: 'Gale' },
        { value: 'Storm', text: 'Storm' },
        { value: 'Typhoon', text: 'Typhoon' }
    ];
    // Create actual Option elements for Wind
    const windOptions = windOptionsData.map(data => {
        const opt = document.createElement('option');
        opt.value = data.value;
        opt.textContent = data.text;
        return opt;
    });

    // Create a map to store options grouped by their type (Rain/Wind)
    const severityMap = {
        // FIX: The HTML value is lowercase ('rain'), so we use 'rain' as the key
        // We will keep the capitalization logic for robustness, but use lowercase keys.
        'rain': rainOptions, 
        'wind': windOptions
    };

    // Function to dynamically update the Severity dropdown
    function updateSeverityOptions() {
        severitySelect.innerHTML = '';
        
        // Use the actual lowercase value from the HTML ('rain' or 'wind')
        const selectedType = alertTypeSelect.value;
        
        // Get the relevant array of options (either rainOptions or windOptions)
        const optionsToShow = severityMap[selectedType] || []; 

        optionsToShow.forEach(option => {
            severitySelect.appendChild(option.cloneNode(true));
        });
        
        if (severitySelect.options.length > 0) {
            severitySelect.selectedIndex = 0;
        }
    }

    // --- 2. Add Event Listener & Initial Call ---
    
    alertTypeSelect.addEventListener('change', updateSeverityOptions);
    
    // This runs on load and will correctly show the Rain options
    updateSeverityOptions(); 
});


      // Auto-hide alerts after 5 seconds
      setTimeout(function() {
        const alerts = document.querySelectorAll('.fixed.top-4');
        alerts.forEach(alert => {
          alert.style.opacity = '0';
          setTimeout(() => alert.style.display = 'none', 500);
        });
      }, 5000);

      // Initialize DataTable and Modal Handlers
      $(document).ready(function() {
        $('#barangayTable').DataTable({
          responsive: true,
          autoWidth: false,
          columnDefs: [
            { responsivePriority: 1, targets: 1 }, // Name
            { responsivePriority: 2, targets: -1 } // Actions
          ]
        });

        // 1. Get the data from the JSON script tag
        // Fallback to empty object if tag is missing or data is invalid
        let LAND_RISK_OPTIONS = {};
        try {
            const scriptTag = document.getElementById('land-risk-options');
            if (scriptTag) {
                // Parse the JSON data from the script tag content
                LAND_RISK_OPTIONS = JSON.parse(scriptTag.textContent);
            }
        } catch (e) {
            console.error("Error parsing LAND_RISK_OPTIONS:", e);
        }

        // --- START: Update Modal Handler (MODIFIED) ---
        $('#updateBarangayModal').on('show.bs.modal', function(event) {
          const button = $(event.relatedTarget);
          const modal = $(this);
          
          // Data from the table row
          const current_id = button.data('id');
          const current_name = button.data('barangay_name');
          const current_land_description = button.data('land_description');
          const current_risk_multiplier = button.data('flood_risk_multiplier');
          const current_summary = button.data('flood_risk_summary');
          
          // 1. Populate the basic and description fields
          modal.find('#update-id').val(current_id);
          modal.find('#update-barangay-name').val(current_name);
          modal.find('#update-land-description').val(current_land_description);

          // 2. Populate the read-only fields initially with current DB values
          modal.find('#display-risk-multiplier').val(current_risk_multiplier);
          modal.find('#update-risk-multiplier').val(current_risk_multiplier);
          modal.find('#display-risk-summary').val(current_summary);
          modal.find('#update-risk-summary').val(current_summary);
        });

        // --- 2. Improved JavaScript Logic for Dependent Dropdowns (NEW) ---
        $('#update-land-description').on('change', function() {
            const selectedKey = $(this).val();
            
            // Check if the selected key exists in the loaded data
            if (selectedKey && LAND_RISK_OPTIONS[selectedKey]) {
                const info = LAND_RISK_OPTIONS[selectedKey];
                
                // Set the value of the hidden input fields (sent with form)
                $('#update-risk-multiplier').val(info.risk_multiplier);
                $('#update-risk-summary').val(info.description);

                // Set the value of the visible, read-only display fields
                $('#display-risk-multiplier').val(info.risk_multiplier);
                $('#display-risk-summary').val(info.description);
            } else {
                // Clear fields if an invalid or no option is selected
                $('#update-risk-multiplier').val('');
                $('#update-risk-summary').val('');
                $('#display-risk-multiplier').val('');
                $('#display-risk-summary').val('Select a Land Description to auto-fill.');
            }
        });
        // --- END: Improved JavaScript Logic ---
        

        // Form submission loading states (Assuming 'updateSensorForm' is a typo for 'updateBarangayForm')
        $('#updateBarangayForm').submit(function() {
          $('#updateSensorSubmitText').html('<i class="fas fa-spinner fa-spin mr-2"></i> Processing...');
          $('#updateSensorSpinner').removeClass('d-none');
          $('#updateSensorSubmit').prop('disabled', true);
        });

        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.forEach(function (tooltipTriggerEl) {
          new bootstrap.Tooltip(tooltipTriggerEl);
        });
      });
      // --- END: JQuery Ready Block ---


      // --- Existing Global Functions ---
      function showLogoutModal() {
        document.getElementById('logoutModal').classList.remove('hidden');
      }

      function hideLogoutModal() {
        document.getElementById('logoutModal').classList.add('hidden');
      }

      function performLogout() {
        // Show loading overlay
        document.getElementById('loadingOverlay').classList.remove('hidden');
        
        hideLogoutModal();
        
        const logoutBtn = document.querySelector('#logout-form button');
        if (logoutBtn) {
          logoutBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Logging out...';
          logoutBtn.disabled = true;
        }
        
        // Submit the form
        document.getElementById('logout-form').submit();
      }

      function toggleRainfallDropdown() {
        const menu = document.getElementById('rainfallMenu');
        const arrow = document.getElementById('rainfallArrow');

        menu.classList.toggle('hidden');

        if (menu.classList.contains('hidden')) {
          arrow.classList.remove('fa-chevron-down');
          arrow.classList.add('fa-chevron-right');
        } else {
          arrow.classList.remove('fa-chevron-right');
          arrow.classList.add('fa-chevron-down');
        }
      }

      function toggleUserDropdown() {
        const menu = document.getElementById('userMenu');
        const arrow = document.getElementById('userArrow');

        menu.classList.toggle('hidden');

        if (menu.classList.contains('hidden')) {
          arrow.classList.remove('fa-chevron-down');
          arrow.classList.add('fa-chevron-right');
        } else {
          arrow.classList.remove('fa-chevron-right');
          arrow.classList.add('fa-chevron-down');
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        const sidebar = document.getElementById('sidebar');
        const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
        const mainContent = document.querySelector('main');

        // Initialize state
        const initSidebar = () => {
            const isDesktop = window.innerWidth >= 768;
            
            if (isDesktop) {
                sidebar.classList.remove('-translate-x-full');
                mainContent.classList.add('md:ml-64');
            } else {
                sidebar.classList.add('-translate-x-full');
                mainContent.classList.remove('md:ml-64');
            }
        };

        // Toggle function
        const toggleSidebar = () => {
            const isDesktop = window.innerWidth >= 768;
            
            sidebar.classList.toggle('-translate-x-full');
            
            // Only adjust margin on desktop
            if (isDesktop) {
                mainContent.classList.toggle('md:ml-64');
                mainContent.classList.toggle('md:ml-0');
            }
        };

        // Handle window resize
        const handleResize = () => {
            const isDesktop = window.innerWidth >= 768;
            
            if (isDesktop) {
                // If sidebar is open on desktop, ensure margin is applied
                if (!sidebar.classList.contains('-translate-x-full')) {
                    mainContent.classList.add('md:ml-64');
                    mainContent.classList.remove('md:ml-0');
                }
            } else {
                // On mobile, remove margin (sidebar will overlay)
                mainContent.classList.remove('md:ml-64');
                mainContent.classList.add('md:ml-0');
            }
        };

        // Event listeners
        if (sidebarToggleBtn) {
          sidebarToggleBtn.addEventListener('click', toggleSidebar);
        }
        window.addEventListener('resize', handleResize);
        
        // Initialize
        initSidebar();
      });
    </script>
</body>
</html>