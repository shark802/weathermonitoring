{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Monthly Reports</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link rel="stylesheet" href="{% static 'weatherapp/css/logout.css' %}">
  <style>
      .dataTables_wrapper {
            z-index: 20; 
            position: relative; 
        }
    @media (max-width: 767px) {
      /* Table scrolling fixes */
      .dataTables_wrapper .dataTables_scroll {
        position: relative;
        width: 100%;
        overflow: auto;
        -webkit-overflow-scrolling: touch;
      }
      
      .dataTables_scrollHead {
        overflow: hidden !important;
        position: relative !important;
      }
      
      .dataTables_scrollHeadInner {
        width: auto !important;
        padding-right: 0 !important;
      }
      
      .dataTables_scrollBody {
        overflow-x: auto !important;
        -webkit-overflow-scrolling: touch;
        max-width: 100vw;
      }
      
      #monthlyTable {
        min-width: 1000px;
        width: auto !important;
      }
      
      .dataTables_scrollHead table {
        margin-bottom: 0 !important;
        border-collapse: collapse !important;
      }
      
      .dataTables_scrollHead th {
        position: relative;
        white-space: nowrap;
        padding: 8px;
      }
      
      /* Other mobile styles */
      main {
        margin-left: 0 !important;
        padding: 1rem !important;
        width: 100vw;
        overflow-x: hidden;
      }
      
      .summary-grid {
        grid-template-columns: repeat(2, 1fr) !important;
      }
      
      .filter-controls {
        gap: 0.5rem !important;
      }
      
      .filter-input {
        min-width: 100% !important;
      }
      
      .dt-buttons {
        flex-wrap: wrap;
        gap: 0.25rem;
        margin-bottom: 0.5rem;
      }
      
      .dt-button {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
      }
      
      .action-btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
      }

      input[type="datetime-local"] {
        min-height: 42px;
      }
    }
    
    @media (min-width: 768px) {
      .summary-grid {
        grid-template-columns: repeat(4, 1fr);
      }
      
      #monthlyTable thead th {
        height: 50px;
        vertical-align: middle;
        position: sticky;
        top: 0;
        z-index: 10;
        background: #2563eb;
      }

      .dataTables_scrollHead {
        position: sticky !important;
        top: 0;
        z-index: 10;
      }

      .dataTables_scrollHeadInner {
        width: auto !important;
      }

      .dataTables_scrollHeadInner table {
        margin-bottom: 0 !important;
      }
    }
    
    /* General improvements */
    .summary-card {
      transition: transform 0.2s;
    }
    
    .summary-card:hover {
      transform: translateY(-2px);
    }
    
    .dataTables_wrapper {
      position: relative;
    }
    
    .dataTables_scrollHeadInner {
      width: auto !important;
    }
    
    .dataTables_scrollBody {
      border-bottom: none !important;
    }

    /* Ensure table cells don't wrap */
    #monthlyTable td, #monthlyTable th {
      white-space: nowrap;
    }
  </style>
</head>
<body class="bg-gray-100 font-sans min-h-screen">

  {% include "weather/header.html" %}

  <div class="flex pt-16">

    {% include "weather/aside.html" %}

    <main class="transition-margin duration-300 flex-1 w-full md:ml-64 mt-0 p-4 md:p-6 space-y-6">
      <div class="info-box w-full">
        <div class="d-flex align-items-center justify-content-center position-relative mb-3 mt-4">
          <h4 class="m-0 text-center w-100">Average Reports per Month</h4>           
        </div>

        <!-- Summary Cards -->
        <div class="grid summary-grid gap-4 mb-6">

          <!-- Temperature -->
          <div class="bg-white p-4 rounded shadow summary-card">
            <h5 class="text-gray-500 text-base font-medium mb-2">Temperature</h5>
            <div class="flex justify-between items-center">
              <div>
                <p class="text-xs text-gray-400">Min</p>
                <p class="text-lg font-bold">
                  {{ summary_stats.min_temp|default:"N/A"|floatformat:1 }}°C
                </p>
                <p class="text-xs text-gray-400">
                  {{ summary_stats.min_temp_date|date:"F Y" }}
                </p>
              </div>
              <div class="text-right">
                <p class="text-xs text-gray-400">Max</p>
                <p class="text-lg font-bold">
                  {{ summary_stats.max_temp|default:"N/A"|floatformat:1 }}°C
                </p>
                <p class="text-xs text-gray-400">
                  {{ summary_stats.max_temp_date|date:"F Y" }}
                </p>
              </div>
            </div>
          </div>

          <!-- Wind Speed -->
          <div class="bg-white p-4 rounded shadow summary-card">
            <h5 class="text-gray-500 text-base font-medium mb-2">Wind Speed</h5>
            <div class="flex justify-between items-center">
              <div>
                <p class="text-xs text-gray-400">Min</p>
                <p class="text-lg font-bold">
                  {{ summary_stats.min_wind|default:"N/A"|floatformat:1 }} m/s
                </p>
                <p class="text-xs text-gray-400">
                  {{ summary_stats.min_wind_date|date:"F Y" }}
                </p>
              </div>
              <div class="text-right">
                <p class="text-xs text-gray-400">Max</p>
                <p class="text-lg font-bold">
                  {{ summary_stats.max_wind|default:"N/A"|floatformat:1 }} m/s
                </p>
                <p class="text-xs text-gray-400">
                  {{ summary_stats.max_wind_date|date:"F Y" }}
                </p>
              </div>
            </div>
          </div>

          <!-- Humidity -->
          <div class="bg-white p-4 rounded shadow summary-card">
            <h5 class="text-gray-500 text-base font-medium mb-2">Humidity</h5>
            <div class="flex justify-between items-center">
              <div>
                <p class="text-xs text-gray-400">Min</p>
                <p class="text-lg font-bold">
                  {{ summary_stats.min_humidity|default:"N/A"|floatformat:1 }}%
                </p>
                <p class="text-xs text-gray-400">
                  {{ summary_stats.min_humidity_date|date:"F Y" }}
                </p>
              </div>
              <div class="text-right">
                <p class="text-xs text-gray-400">Max</p>
                <p class="text-lg font-bold">
                  {{ summary_stats.max_humidity|default:"N/A"|floatformat:1 }}%
                </p>
                <p class="text-xs text-gray-400">
                  {{ summary_stats.max_humidity_date|date:"F Y" }}
                </p>
              </div>
            </div>
          </div>

          <!-- Rainfall -->
          <div class="bg-white p-4 rounded shadow summary-card">
            <h5 class="text-gray-500 text-base font-medium mb-2">Rainfall</h5>
            <div class="flex justify-between items-center">
              <div>
                <p class="text-xs text-gray-400">Min</p>
                <p class="text-lg font-bold">
                  {{ summary_stats.min_rain|default:"N/A"|floatformat:2 }} mm
                </p>
                <p class="text-xs text-gray-400">
                  {{ summary_stats.min_rain_date|date:"F Y" }}
                </p>
              </div>
              <div class="text-right">
                <p class="text-xs text-gray-400">Max</p>
                <p class="text-lg font-bold">
                  {{ summary_stats.max_rain|default:"N/A"|floatformat:2 }} mm
                </p>
                <p class="text-xs text-gray-400">
                  {{ summary_stats.max_rain_date|date:"F Y" }}
                </p>
              </div>
            </div>
          </div>

        </div>

        <!-- Year Selection and Filters -->
        <div class="bg-white p-4 rounded shadow mb-6">
          <div class="flex flex-wrap filter-controls gap-4 mb-4">
            <div class="flex-1 min-w-[200px] filter-input">
              <label for="yearSelect" class="block text-sm font-medium text-gray-700">Year</label>
              <select id="yearSelect" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                {% for year in available_years %}
                <option value="{{ year }}" {% if year == current_year %}selected{% endif %}>{{ year }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="flex-1 min-w-[200px] filter-input">
              <label for="monthSelect" class="block text-sm font-medium text-gray-700">Month</label>
              <select id="monthSelect" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                <option value="">All Months</option>
                {% for month in month_names %}
                <option value="{{ forloop.counter }}" {% if forloop.counter == current_month %}selected{% endif %}>{{ month }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="flex-1 min-w-[200px] filter-input">
              <label for="sensorFilter" class="block text-sm font-medium text-gray-700">Sensor</label>
              <select id="sensorFilter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                <option value="">All Sensors</option>
                {% for sensor in sensors %}
                <option value="{{ sensor.sensor_id }}">{{ sensor.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="self-end">
              <button id="filterBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition action-btn">
                <i class="fas fa-filter mr-2"></i>Filter
              </button>
              <button id="resetBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition ml-2 action-btn">
                <i class="fas fa-sync-alt mr-2"></i>Reset
              </button>
            </div>
          </div>
        </div>

        <!-- Data Table -->
        <div class="table-responsive bg-white rounded shadow">
          <table id="monthlyTable" class="min-w-full border border-gray-300 text-sm">
            <thead class="bg-blue-600 text-white">
              <tr>
                <th>Sensor</th>
                <th>Month</th>
                <th>Temperature (°C)</th>
                <th>Humidity (%)</th>
                <th>Wind Speed (m/s)</th>
                <th>Pressure (hPa)</th>
                <th>Dew Point (°C)</th>
                <th>Rain Rate (mm/h)</th>
                <th>Rain (mm)</th>
              </tr>
            </thead>
            <tbody>
              {% if reports %}
                {% for report in reports %}
                <tr>
                  <td>{{ report.name|default:"N/A" }}</td>
                  <td>{{ report.month|date:"F Y"|default:"N/A" }}</td>
                  <td>{{ report.avg_temperature|floatformat:1|default:"N/A" }}</td>
                  <td>{{ report.avg_humidity|floatformat:1|default:"N/A" }}</td>
                  <td>{{ report.avg_wind_speed|floatformat:1|default:"N/A" }}</td>
                  <td>{{ report.avg_barometric_pressure|floatformat:1|default:"N/A" }}</td>
                  <td>{{ report.avg_dew_point|floatformat:1|default:"N/A" }}</td>
                  <td>{{ report.avg_rain_rate|floatformat:2|default:"N/A" }}</td>
                  <td>{{ report.total_rain_accumulated|floatformat:2|default:"N/A" }}</td>
                </tr>
                {% endfor %}
              {% else %}
                <tr>
                  <td colspan="10" class="text-center py-4 text-gray-500">No monthly reports available</td>
                </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <!--logout modal-->
  <div id="logoutModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="fixed inset-0 bg-gray-900 bg-opacity-50 transition-opacity" aria-hidden="true"></div>
      
      <div class="relative bg-white rounded-xl shadow-2xl overflow-hidden w-full max-w-md transform transition-all">
        <div class="p-6">
          <div class="flex items-start">
            <div class="flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-50">
              <i class="fas fa-sign-out-alt text-red-600 text-xl"></i>
            </div>
            
            <div class="ml-4">
              <h3 class="text-xl font-semibold text-gray-900">Log out of your account?</h3>
              <div class="mt-2">
                <p class="text-gray-600">You'll need to log in again to access your dashboard.</p>
              </div>
            </div>
          </div>
        </div>
        
        <div class="bg-gray-50 px-6 py-4 flex flex-col-reverse sm:flex-row sm:justify-end gap-3">
          <button type="button" onclick="hideLogoutModal()" 
                  class="px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors">
            Cancel
          </button>
          <button type="button" onclick="performLogout()" 
                  class="px-4 py-2 text-sm font-medium text-white bg-red-600 hover:bg-red-700 rounded-lg shadow-sm transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
            Log Out
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="sendAlertModal" tabindex="-1" aria-labelledby="sendAlertModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-xl rounded-xl">
            <form method="POST" action="{% url 'send_alert' %}" id="sendAlertForm">
                {% csrf_token %}
                <div class="modal-header bg-red-600 text-white rounded-t-xl border-b-0 relative">
                    <div class="w-full text-center py-2">
                        <h5 class="modal-title text-2xl font-extrabold" id="sendAlertModalLabel">
                            <i class="fas fa-bullhorn mr-2"></i> SEND EMERGENCY ALERT
                        </h5>
                    </div>
                    <button type="button" class="btn-close btn-close-white absolute right-4 top-4 opacity-70 hover:opacity-100 transition" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <div class="modal-body p-6 space-y-6">
                    <h6 class="font-bold text-lg text-red-700 flex items-center border-b pb-2 mb-4">
                        <i class="fas fa-exclamation-triangle mr-2 text-red-500"></i>
                        Alert Details & Message
                    </h6>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="alert_type" class="block text-sm font-bold text-gray-700 mb-1">Alert Type</label>
                            <select class="w-full rounded-lg border-gray-300 focus:border-red-500 focus:ring-red-500 shadow-sm transition" 
                                    id="alert_type" name="alert_type" required>
                                <option value="rain">Rain Alert</option>
                                <option value="wind">Wind Alert</option>
                            </select>
                        </div>
                        <div>
                            <label for="severity" class="block text-sm font-bold text-gray-700 mb-1">Severity Level</label>
                            <select class="w-full rounded-lg border-gray-300 focus:border-red-500 focus:ring-red-500 shadow-sm transition" 
                                    id="severity" name="severity" required>
                                <option value="Heavy">Heavy</option>
                                <option value="Intense">Intense</option>
                                <option value="Torrential">Torrential</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label for="alert_message" class="block text-sm font-bold text-gray-700 mb-1">Custom Alert Message</label>
                        <textarea class="w-full rounded-lg border-gray-300 focus:border-red-500 focus:ring-red-500 shadow-sm" 
                                  id="alert_message" name="alert_message" rows="3" 
                                  placeholder="E.g., Expect severe flooding in low-lying areas. Seek higher ground immediately."></textarea>
                    </div>

                    <div id="alert-status" class="mt-4 text-center font-bold text-sm"></div>
                </div>
                
                <div class="modal-footer bg-gray-50 rounded-b-xl px-6 py-4 flex flex-col sm:flex-row-reverse gap-3">
                    <button type="submit" 
                              class="w-full sm:w-auto px-6 py-2 bg-red-600 text-white font-extrabold rounded-lg hover:bg-red-700 focus:outline-none focus:ring-4 focus:ring-red-300 transition-colors shadow-md flex items-center justify-center gap-2 text-lg"
                              id="sendAlertButton">
                        <i class="fas fa-paper-plane"></i> Send Alert
                    </button>
                    <button type="button" 
                              class="w-full sm:w-auto px-6 py-2 bg-white border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-colors shadow-sm"
                              data-bs-dismiss="modal">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

  <!--logout loading-->
  <div id="loadingOverlay" class="hidden fixed inset-0 z-50 bg-white bg-opacity-80 flex flex-col items-center justify-center">
    <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
    <p class="mt-4 text-lg font-medium text-gray-700">Logging out...</p>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/responsive/2.4.1/js/dataTables.responsive.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
    const alertTypeSelect = document.getElementById('alert_type');
    const severitySelect = document.getElementById('severity');
    
    // --- 1. Robustly Group Options ---
    const allOptions = Array.from(severitySelect.options);

    // FIX: Define the complete list of all potential severity options.
    // Since the original HTML only had Rain options, we add the Wind options here.
    // If your HTML contained all options (Rain first, then Wind), this logic would be simpler.
    
    // 1. Group the currently visible options (Rain options)
    const rainOptions = allOptions; 

    // 2. Define the missing Wind options (assuming these are the desired levels)
    const windOptionsData = [
        { value: 'Gale', text: 'Gale' },
        { value: 'Storm', text: 'Storm' },
        { value: 'Typhoon', text: 'Typhoon' }
    ];
    // Create actual Option elements for Wind
    const windOptions = windOptionsData.map(data => {
        const opt = document.createElement('option');
        opt.value = data.value;
        opt.textContent = data.text;
        return opt;
    });

    // Create a map to store options grouped by their type (Rain/Wind)
    const severityMap = {
        // FIX: The HTML value is lowercase ('rain'), so we use 'rain' as the key
        // We will keep the capitalization logic for robustness, but use lowercase keys.
        'rain': rainOptions, 
        'wind': windOptions
    };

    // Function to dynamically update the Severity dropdown
    function updateSeverityOptions() {
        severitySelect.innerHTML = '';
        
        // Use the actual lowercase value from the HTML ('rain' or 'wind')
        const selectedType = alertTypeSelect.value;
        
        // Get the relevant array of options (either rainOptions or windOptions)
        const optionsToShow = severityMap[selectedType] || []; 

        optionsToShow.forEach(option => {
            severitySelect.appendChild(option.cloneNode(true));
        });
        
        if (severitySelect.options.length > 0) {
            severitySelect.selectedIndex = 0;
        }
    }

    // --- 2. Add Event Listener & Initial Call ---
    
    alertTypeSelect.addEventListener('change', updateSeverityOptions);
    
    // This runs on load and will correctly show the Rain options
    updateSeverityOptions(); 
});

    function showLogoutModal() {
      document.getElementById('logoutModal').classList.remove('hidden');
    }

    function hideLogoutModal() {
      document.getElementById('logoutModal').classList.add('hidden');
    }

    function performLogout() {
      // Show loading overlay
      document.getElementById('loadingOverlay').classList.remove('hidden');
      
      hideLogoutModal();
      
      const logoutBtn = document.querySelector('#logout-form button');
      if (logoutBtn) {
        logoutBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Logging out...';
        logoutBtn.disabled = true;
      }
      
      // Submit the form
      document.getElementById('logout-form').submit();
    }

    function toggleRainfallDropdown() {
      const menu = document.getElementById('rainfallMenu');
      const arrow = document.getElementById('rainfallArrow');

      menu.classList.toggle('hidden');

      if (menu.classList.contains('hidden')) {
        arrow.classList.remove('fa-chevron-down');
        arrow.classList.add('fa-chevron-right');
      } else {
        arrow.classList.remove('fa-chevron-right');
        arrow.classList.add('fa-chevron-down');
      }
    }

    function toggleUserDropdown() {
      const menu = document.getElementById('userMenu');
      const arrow = document.getElementById('userArrow');

      menu.classList.toggle('hidden');

      if (menu.classList.contains('hidden')) {
        arrow.classList.remove('fa-chevron-down');
        arrow.classList.add('fa-chevron-right');
      } else {
        arrow.classList.remove('fa-chevron-right');
        arrow.classList.add('fa-chevron-down');
      }
    }

$(document).ready(function () {
    // Initialize DataTable with enhanced features
    var table = $('#monthlyTable').DataTable({
        scrollX: true,
        responsive: false,
        dom: 'Bfrtip',
        buttons: [
            {
                extend: 'excel',
                exportOptions: {
                    columns: ':visible'
                }
            },
            {
                extend: 'pdf',
                exportOptions: {
                    columns: ':visible'
                }
            },
            {
                extend: 'print',
                exportOptions: {
                    columns: ':visible'
                }
            },
            'colvis'
        ],
        pageLength: 12,
        lengthMenu: [[6, 12, 24, 36, -1], [6, 12, 24, 36, "All"]],
        language: {
            search: "_INPUT_",
            searchPlaceholder: "Search reports...",
        },
        order: [[1, 'desc']], // Default sort by month descending
        columnDefs: [
            { 
                type: 'month-year', 
                targets: 1,
                render: function(data, type, row) {
                    if (type === 'sort') {
                        // Return a sortable format (timestamp)
                        var months = ['January', 'February', 'March', 'April', 'May', 'June', 
                                    'July', 'August', 'September', 'October', 'November', 'December'];
                        var parts = data.split(' ');
                        var month = months.indexOf(parts[0]);
                        var year = parts[1];
                        return new Date(year, month, 1).getTime();
                    }
                    return data;
                }
            },
            { 
                targets: '_all', 
                className: "text-center",
                defaultContent: ""
            }
        ]
    });

    // Fix for horizontal scrolling on window resize
    $(window).on('resize', function() {
        table.columns.adjust().draw();
    });

    // Fix for horizontal scrolling after sidebar toggle
    document.getElementById('sidebarToggleBtn')?.addEventListener('click', function() {
        setTimeout(function() {
            table.columns.adjust().draw();
        }, 300);
    });

    // Set default year to current year and month to empty (all months)
    var currentDate = new Date();
    $('#yearSelect').val(currentDate.getFullYear());
    $('#monthSelect').val('');

    // Remove duplicate filter button event listener
    $('#filterBtn').on('click', function() {
        loadData();
    });

    // Reset button functionality
    $('#resetBtn').on('click', function() {
        var currentDate = new Date();
        $('#yearSelect').val(currentDate.getFullYear());
        $('#monthSelect').val('');
        $('#sensorFilter').val('');
        loadData();
    });

    // Initial data load
    loadData();

    function loadData() {
        $('#filterBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-2"></i>Loading...');
        
        var year = $('#yearSelect').val();
        var month = $('#monthSelect').val();
        var sensorId = $('#sensorFilter').val();
        
        $.ajax({
            url: '{% url "monthly_reports" %}',
            type: 'GET',
            data: {
                'year': year,
                'month': month,
                'sensor_id': sensorId
            },
            success: function(response) {
                table.clear();
                
                if (response.reports && response.reports.length > 0) {
                    var processedData = response.reports.map(function(report) {
                        return [
                            report.name || 'N/A',
                            report.month || 'N/A',
                            report.avg_temperature !== undefined && report.avg_temperature !== null ? parseFloat(report.avg_temperature).toFixed(1) + '°C' : 'N/A',
                            report.avg_humidity !== undefined && report.avg_humidity !== null ? parseFloat(report.avg_humidity).toFixed(1) + '%' : 'N/A',
                            report.avg_wind_speed !== undefined && report.avg_wind_speed !== null ? parseFloat(report.avg_wind_speed).toFixed(1) + ' m/s' : 'N/A',
                            report.avg_barometric_pressure !== undefined && report.avg_barometric_pressure !== null ? parseFloat(report.avg_barometric_pressure).toFixed(1) + ' hPa' : 'N/A',
                            report.avg_dew_point !== undefined && report.avg_dew_point !== null ? parseFloat(report.avg_dew_point).toFixed(1) + '°C' : 'N/A',
                            report.avg_rain_rate !== undefined && report.avg_rain_rate !== null ? parseFloat(report.avg_rain_rate).toFixed(1) + ' mm/h' : 'N/A',
                            report.total_rain_accumulated !== undefined && report.total_rain_accumulated !== null ? parseFloat(report.total_rain_accumulated).toFixed(1) + ' mm' : 'N/A'
                        ];
                    });
                    
                    table.rows.add(processedData).draw();
                } else {
                    table.clear().draw();
                }
                
                if (response.summary_stats) {
                    updateSummaryCards(response.summary_stats);
                }
            },
            error: function(xhr, status, error) {
                console.error('Error:', error);
                alert('Error loading data. Please try again.');
                table.clear().draw();
            },
            complete: function() {
                $('#filterBtn').prop('disabled', false).html('<i class="fas fa-filter mr-2"></i>Filter');
            }
        });
    }

    function updateSummaryCards(stats) {
        $('.summary-card:nth-child(1) .text-2xl').text(
            stats.avg_temp !== undefined && stats.avg_temp !== null ? parseFloat(stats.avg_temp).toFixed(1) + '°C' : 'N/A'
        );
        $('.summary-card:nth-child(2) .text-2xl').text(
            stats.max_wind !== undefined && stats.max_wind !== null ? parseFloat(stats.max_wind).toFixed(1) + ' m/s' : 'N/A'
        );
        $('.summary-card:nth-child(3) .text-2xl').text(
            stats.avg_humidity !== undefined && stats.avg_humidity !== null ? parseFloat(stats.avg_humidity).toFixed(1) + '%' : 'N/A'
        );
        $('.summary-card:nth-child(4) .text-2xl').text(
            stats.total_rain !== undefined && stats.total_rain !== null ? parseFloat(stats.total_rain).toFixed(1) + ' mm' : 'N/A'
        );
    }

    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.forEach(function (tooltipTriggerEl) {
        new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

    document.addEventListener('DOMContentLoaded', () => {
      const sidebar = document.getElementById('sidebar');
      const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
      const mainContent = document.querySelector('main');

      // Initialize state
      const initSidebar = () => {
        const isDesktop = window.innerWidth >= 768;
        
        if (isDesktop) {
          sidebar.classList.remove('-translate-x-full');
          mainContent.classList.add('md:ml-64');
        } else {
          sidebar.classList.add('-translate-x-full');
          mainContent.classList.remove('md:ml-64');
        }
      };

      // Toggle function
      const toggleSidebar = () => {
        const isDesktop = window.innerWidth >= 768;
        
        sidebar.classList.toggle('-translate-x-full');
        
        if (isDesktop) {
          mainContent.classList.toggle('md:ml-64');
          mainContent.classList.toggle('md:ml-0');
        }
      };

      // Handle window resize
      const handleResize = () => {
        const isDesktop = window.innerWidth >= 768;
        
        if (isDesktop) {
          if (!sidebar.classList.contains('-translate-x-full')) {
            mainContent.classList.add('md:ml-64');
            mainContent.classList.remove('md:ml-0');
          }
        } else {
          mainContent.classList.remove('md:ml-64');
          mainContent.classList.add('md:ml-0');
        }
      };

      // Event listeners
      sidebarToggleBtn?.addEventListener('click', toggleSidebar);
      window.addEventListener('resize', handleResize);
      
      // Initialize
      initSidebar();
    });

    $(document).ready(function() {
    $('#sendAlertForm').on('submit', function(e) {
        // 1. Prevent default form submission (stops page refresh)
        e.preventDefault(); 
        
        var form = $(this);
        var url = form.attr('action');
        var method = form.attr('method');
        var data = form.serialize();
        var $statusDiv = $('#alert-status');
        var $button = $('#sendAlertButton');

        // Clear previous status and disable button
        $statusDiv.html('<i class="fas fa-spinner fa-spin mr-2"></i> Sending alert...');
        $statusDiv.removeClass('text-green-600 text-red-600 text-yellow-600').addClass('text-gray-600');
        $button.prop('disabled', true).html('<i class="fas fa-paper-plane"></i> Sending...');

        // 2. Send data via AJAX
        $.ajax({
            type: method,
            url: url,
            data: data,
            dataType: 'json', // Expecting JSON response from Django view
            success: function(response) {
                // 3. Update modal based on JSON response
                if (response.status === 'success') {
                    $statusDiv.html('<i class="fas fa-check-circle mr-2"></i> ' + response.message);
                    $statusDiv.removeClass('text-gray-600').addClass('text-green-600');
                    // Optionally close the modal after a delay
                    setTimeout(function() {
                        $('#sendAlertModal').modal('hide');
                    }, 3000); 
                } else if (response.status === 'warning') {
                    $statusDiv.html('<i class="fas fa-exclamation-circle mr-2"></i> ' + response.message);
                    $statusDiv.removeClass('text-gray-600').addClass('text-yellow-600');
                } else { // status === 'error'
                    $statusDiv.html('<i class="fas fa-times-circle mr-2"></i> ' + response.message);
                    $statusDiv.removeClass('text-gray-600').addClass('text-red-600');
                }
            },
            error: function(xhr, status, error) {
                // Handle network or server-side error (e.g., 500 status)
                $statusDiv.html('<i class="fas fa-exclamation-triangle mr-2"></i> A critical error occurred: ' + error);
                $statusDiv.removeClass('text-gray-600').addClass('text-red-600');
            },
            complete: function() {
                // Re-enable the button regardless of success/error
                $button.prop('disabled', false).html('<i class="fas fa-paper-plane"></i> Send Alert');
            }
        });
    });
});
  </script>
</body>
</html>